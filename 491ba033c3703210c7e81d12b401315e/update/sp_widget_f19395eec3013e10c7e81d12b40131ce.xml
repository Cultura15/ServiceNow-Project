<?xml version="1.0" encoding="UTF-8"?><record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <category>custom</category>
        <client_script><![CDATA[api.controller = function($scope, $window, spUtil, $log, $timeout) {
  var c = this;

  c.cartItems = c.data.cartItems || [];
  c.totalItems = c.data.totalItems || 0;
  c.grandTotal = c.data.grandTotal || 0;

  // Remove item
  c.removeFromCart = function(sys_id) {
    if (!confirm("Remove this item from your cart?")) return;

    c.data.action = 'remove_item';
    c.data.sys_id = sys_id;

    c.server.update(c.data).then(function(response) {
      if (response.success) {
        spUtil.addInfoMessage("]]>üóë<![CDATA[ Item removed!");
        c.cartItems = response.cartItems;
        c.totalItems = response.totalItems;
        c.grandTotal = response.grandTotal;
      } else {
        spUtil.addErrorMessage("‚ùå Failed to remove item: " + (response.error || "Unknown error"));
      }
    });
  };

  // Checkout
  c.checkout = function() {
    if (!c.cartItems || c.cartItems.length === 0) {
      spUtil.addErrorMessage("Cart is empty!");
      return;
    }

    if (!confirm("Proceed to checkout?")) return;

    c.data.action = 'checkout';
    c.data.cartItems = angular.copy(c.cartItems);

    $log.info("]]>üßæ<![CDATA[ Sending checkout payload:", c.data);

    c.isLoading = true;
    c.server.update(c.data).then(function(response) {
      c.isLoading = false;

      if (response.success) {
        const orderNum = response.order_number || "N/A";
        spUtil.addInfoMessage("‚úÖ Order #" + orderNum + " placed successfully!");

        // Reset UI
        c.cartItems = [];
        c.totalItems = 0;
        c.grandTotal = 0;

        // Redirect to "My Orders" tracker after 1.5s
        $timeout(function() {
          $window.location.href = '/psmp?id=psmp_my_orders';
        }, 1500);
      } else {
        spUtil.addErrorMessage("‚ùå Checkout failed: " + (response.error || "Please try again."));
      }
    }).catch(function(error) {
      c.isLoading = false;
      $log.error("‚ùå Checkout error:", error);
      spUtil.addErrorMessage("An unexpected error occurred during checkout.");
    });
  };

  // Open item details
  c.openItem = function(itemSysId) {
    if (!itemSysId) {
      spUtil.addErrorMessage("‚ùå Item not found!");
      return;
    }
    $window.location.href = '/psmp?id=psmp_order&item_sys_id=' + itemSysId;
  };

  // Back to shop
  c.goBack = function() {
    $window.location.href = '/psmp?id=psmp_shop';
  };
};

api.controller.$inject = ['$scope', '$window', 'spUtil', '$log', '$timeout'];
]]></client_script>
        <controller_as>c</controller_as>
        <css>.sn-cart-container {&#13;
  max-width: 1200px;&#13;
  margin: 0 auto;&#13;
  padding: 20px;&#13;
  font-family: "Segoe UI", Roboto, sans-serif;&#13;
  color: #333;&#13;
}&#13;
&#13;
/* HEADER */&#13;
.sn-cart-container .cart-header {&#13;
  display: flex;&#13;
  justify-content: space-between;&#13;
  align-items: center;&#13;
  margin-bottom: 32px;&#13;
  padding-bottom: 20px;&#13;
  border-bottom: 1px solid #eee;&#13;
}&#13;
&#13;
.sn-cart-container .cart-title {&#13;
  display: flex;&#13;
  align-items: center;&#13;
  gap: 10px;&#13;
  font-size: 28px;&#13;
  font-weight: bold;&#13;
  color: #2c3e50;&#13;
}&#13;
&#13;
.sn-cart-container .item-count-badge {&#13;
  background: #27ae60;&#13;
  color: #fff;&#13;
  padding: 5px 15px;&#13;
  border-radius: 20px;&#13;
  font-size: 14px;&#13;
  font-weight: 600;&#13;
}&#13;
&#13;
.sn-cart-container .continue-shopping-btn {&#13;
  border: 1px solid #bbb;&#13;
  padding: 8px 20px;&#13;
  border-radius: 8px;&#13;
  background: #fff;&#13;
  font-weight: 600;&#13;
  transition: 0.2s;&#13;
}&#13;
&#13;
.sn-cart-container .continue-shopping-btn:hover {&#13;
  background: #f0f0f0;&#13;
  border-color: #27ae60;&#13;
  color: #27ae60;&#13;
}&#13;
&#13;
/* LAYOUT */&#13;
.sn-cart-container .cart-layout {&#13;
  display: grid;&#13;
  grid-template-columns: 1fr 380px;&#13;
  gap: 24px;&#13;
}&#13;
&#13;
/* CART ITEM */&#13;
.sn-cart-container .cart-item {&#13;
  background: #fff;&#13;
  border-radius: 16px;&#13;
  padding: 20px;&#13;
  display: flex;&#13;
  gap: 16px;&#13;
  box-shadow: 0 3px 15px rgba(0,0,0,0.08);&#13;
  transition: transform 0.3s, box-shadow 0.3s;&#13;
}&#13;
&#13;
.sn-cart-container .cart-item:hover {&#13;
  transform: translateY(-3px);&#13;
  box-shadow: 0 6px 20px rgba(0,0,0,0.12);&#13;
}&#13;
&#13;
.sn-cart-container .item-content {&#13;
  display: flex;&#13;
  gap: 16px;&#13;
  flex: 1;&#13;
  cursor: pointer;&#13;
}&#13;
&#13;
.sn-cart-container .item-image {&#13;
  width: 120px;&#13;
  height: 120px;&#13;
  border-radius: 12px;&#13;
  object-fit: cover;&#13;
  transition: transform 0.3s;&#13;
}&#13;
&#13;
.sn-cart-container .item-content:hover .item-image {&#13;
  transform: scale(1.05);&#13;
}&#13;
&#13;
.sn-cart-container .item-details {&#13;
  display: flex;&#13;
  flex-direction: column;&#13;
  gap: 8px;&#13;
}&#13;
&#13;
.sn-cart-container .item-name {&#13;
  font-weight: 600;&#13;
  font-size: 18px;&#13;
  margin: 0;&#13;
  color: #2c3e50;&#13;
}&#13;
&#13;
.sn-cart-container .item-meta {&#13;
  display: flex;&#13;
  gap: 12px;&#13;
  font-size: 13px;&#13;
  color: #7f8c8d;&#13;
}&#13;
&#13;
.sn-cart-container .unit-price,&#13;
.sn-cart-container .quantity-value,&#13;
.sn-cart-container .total-price {&#13;
  font-weight: 600;&#13;
}&#13;
&#13;
.sn-cart-container .item-total {&#13;
  margin-top: auto;&#13;
  font-size: 16px;&#13;
  font-weight: bold;&#13;
  color: #27ae60;&#13;
}&#13;
&#13;
/* REMOVE BUTTON */&#13;
.sn-cart-container .remove-item-btn {&#13;
  background: #ffe6e6;&#13;
  border: 1px solid #ff4d4d;&#13;
  padding: 8px 14px;&#13;
  border-radius: 8px;&#13;
  color: #c0392b;&#13;
  font-weight: 600;&#13;
  display: flex;&#13;
  align-items: center;&#13;
  gap: 5px;&#13;
  cursor: pointer;&#13;
  height: fit-content;&#13;
  transition: 0.2s;&#13;
}&#13;
&#13;
.sn-cart-container .remove-item-btn:hover {&#13;
  background: #ffcccc;&#13;
  transform: translateY(-2px);&#13;
}&#13;
&#13;
/* ORDER SUMMARY */&#13;
.sn-cart-container .order-summary {&#13;
  position: sticky;&#13;
  top: 20px;&#13;
}&#13;
&#13;
.sn-cart-container .summary-card {&#13;
  background: #fff;&#13;
  border-radius: 16px;&#13;
  padding: 24px;&#13;
  box-shadow: 0 3px 15px rgba(0,0,0,0.08);&#13;
}&#13;
&#13;
.sn-cart-container .summary-title {&#13;
  font-weight: bold;&#13;
  font-size: 20px;&#13;
  margin-bottom: 20px;&#13;
}&#13;
&#13;
.sn-cart-container .summary-details {&#13;
  display: flex;&#13;
  flex-direction: column;&#13;
  gap: 10px;&#13;
}&#13;
&#13;
.sn-cart-container .summary-row {&#13;
  display: flex;&#13;
  justify-content: space-between;&#13;
}&#13;
&#13;
.sn-cart-container .total-amount {&#13;
  color: #27ae60;&#13;
  font-size: 22px;&#13;
  font-weight: bold;&#13;
}&#13;
&#13;
/* CHECKOUT BUTTON */&#13;
.sn-cart-container .checkout-btn {&#13;
  width: 100%;&#13;
  background: #27ae60;&#13;
  color: #fff;&#13;
  padding: 14px;&#13;
  border-radius: 12px;&#13;
  margin-top: 20px;&#13;
  font-weight: bold;&#13;
  font-size: 16px;&#13;
  display: flex;&#13;
  justify-content: center;&#13;
  gap: 8px;&#13;
  transition: 0.3s;&#13;
}&#13;
&#13;
.sn-cart-container .checkout-btn:hover:not(:disabled) {&#13;
  background: #2ecc71;&#13;
  transform: translateY(-2px);&#13;
}&#13;
&#13;
.sn-cart-container .checkout-btn:disabled {&#13;
  opacity: 0.6;&#13;
  cursor: not-allowed;&#13;
}&#13;
&#13;
/* EMPTY CART */&#13;
.sn-cart-container .empty-cart-state {&#13;
  text-align: center;&#13;
  padding: 60px 20px;&#13;
}&#13;
&#13;
.sn-cart-container .empty-cart-icon {&#13;
  font-size: 100px;&#13;
  opacity: 0.3;&#13;
  margin-bottom: 20px;&#13;
}&#13;
&#13;
.sn-cart-container .shop-now-btn {&#13;
  background: #27ae60;&#13;
  color: #fff;&#13;
  padding: 14px 36px;&#13;
  border-radius: 12px;&#13;
  font-weight: bold;&#13;
  font-size: 16px;&#13;
  transition: 0.3s;&#13;
}&#13;
&#13;
.sn-cart-container .shop-now-btn:hover {&#13;
  background: #2ecc71;&#13;
  transform: translateY(-2px);&#13;
}&#13;
&#13;
/* RESPONSIVE */&#13;
@media(max-width: 980px) {&#13;
  .sn-cart-container .cart-layout {&#13;
    grid-template-columns: 1fr;&#13;
  }&#13;
  .sn-cart-container .order-summary {&#13;
    position: static;&#13;
    margin-top: 20px;&#13;
  }&#13;
}&#13;
</css>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>false</has_preview>
        <id/>
        <internal>false</internal>
        <link><![CDATA[function link(scope, element, attrs, controller) {
  
}]]></link>
        <name>Pet Shop Cart</name>
        <option_schema/>
        <public>false</public>
        <roles>x_1607167_pet_shop.Pet Shop User</roles>
        <script><![CDATA[(function() {
  data.cartItems = [];
  data.totalItems = 0;
  data.grandTotal = 0;

  var currentUser = gs.getUserID();

  // ---------------------------------------------
  // Load active cart items
  // ---------------------------------------------
  var cart = new GlideRecord("x_1607167_pet_shop_pet_shop_cart");
  cart.addQuery("user", currentUser);
  cart.addQuery("active", true);
  cart.addQuery("ordered", false);
  cart.query();

  while (cart.next()) {
    if (cart.order_linked === undefined) {
      cart.order_linked = false;
      cart.update();
    }

    data.cartItems.push({
      sys_id: cart.getUniqueValue(),
      item: cart.item.getDisplayValue(),
      item_sys_id: cart.getValue("item"),
      brand: cart.getValue("brand"),
      category: cart.getValue("category"),
      price: parseFloat(cart.getValue("price") || 0),
      quantity: parseInt(cart.getValue("quantity") || 0, 10),
      total_price: parseFloat(cart.getValue("total_price") || 0),
      image: cart.getValue("image")
    });
  }

  data.totalItems = data.cartItems.length;
  data.grandTotal = data.cartItems.reduce(function(sum, item) {
    return sum + item.total_price;
  }, 0);

  // ---------------------------------------------
  // Remove item
  // ---------------------------------------------
  if (input && input.action === "remove_item") {
    var rm = new GlideRecord("x_1607167_pet_shop_pet_shop_cart");
    if (rm.get(input.sys_id)) {
      rm.active = false;
      rm.update();
    }

    // Reload cart
    var reload = new GlideRecord("x_1607167_pet_shop_pet_shop_cart");
    reload.addQuery("user", currentUser);
    reload.addQuery("active", true);
    reload.addQuery("ordered", false);
    reload.query();

    data.cartItems = [];
    while (reload.next()) {
      data.cartItems.push({
        sys_id: reload.getUniqueValue(),
        item: reload.item.getDisplayValue(),
        brand: reload.getValue("brand"),
        category: reload.getValue("category"),
        price: parseFloat(reload.getValue("price") || 0),
        quantity: parseInt(reload.getValue("quantity") || 0, 10),
        total_price: parseFloat(reload.getValue("total_price") || 0),
        image: reload.getValue("image")
      });
    }

    data.totalItems = data.cartItems.length;
    data.grandTotal = data.cartItems.reduce(function(sum, item) {
      return sum + item.total_price;
    }, 0);

    data.success = true;
    return;
  }

  // ---------------------------------------------
  // Checkout logic
  // ---------------------------------------------
  if (input && input.action === "checkout") {
    if (!data.cartItems || data.cartItems.length === 0) {
      data.success = false;
      data.error = "Cart is empty!";
      return;
    }

    var order = new GlideRecord("x_1607167_pet_shop_pet_shop_order");
    if (!order.isValid()) {
      data.success = false;
      data.error = "Order table invalid";
      return;
    }

    // ]]>üÜï<![CDATA[ Create order
    order.initialize();
    order.order_for = currentUser;
    order.state = "1"; // Pending
    order.short_description = "Order with " + data.totalItems + " item(s)";
    order.total_amount = data.grandTotal;

    var orderSysId = order.insert();
    var orderNumber = order.getDisplayValue("number");
    gs.info("‚úÖ Created parent order: " + orderNumber);

    // ]]>üßæ<![CDATA[ Create order details
    var markCart = new GlideRecord("x_1607167_pet_shop_pet_shop_cart");
    markCart.addQuery("user", currentUser);
    markCart.addQuery("active", true);
    markCart.addQuery("ordered", false);
    markCart.query();

    var createdDetails = 0;
    while (markCart.next()) {
      markCart.ordered = true;
      markCart.active = false;
      markCart.order_linked = true;
      markCart.parent_order = orderSysId;
      markCart.update();

      var detail = new GlideRecord("x_1607167_pet_shop_pet_shop_order_details");
      detail.initialize();
      detail.pet_shop_order = orderSysId;
      detail.item_name = markCart.item.getDisplayValue();
      detail.brand = markCart.getValue("brand");
      detail.category = markCart.getValue("category");
      detail.quantity = markCart.getValue("quantity");
      detail.price = markCart.getValue("price");
      detail.image = markCart.getValue("image");
      detail.insert();

      createdDetails++;
    }

    gs.info("‚úÖ Created " + createdDetails + " order details for order: " + orderNumber);

    data.success = true;
    data.message =
      "‚úÖ Checkout complete! Your order #" +
      orderNumber +
      " has been created with " + createdDetails + " items.";

    // Send back order info for redirection
    data.order_number = orderNumber;
    data.order_sys_id = orderSysId;

    // Clear cart
    data.cartItems = [];
    data.totalItems = 0;
    data.grandTotal = 0;

    return;
  }
})();
]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-11-09 10:36:23</sys_created_on>
        <sys_id>f19395eec3013e10c7e81d12b40131ce</sys_id>
        <sys_mod_count>20</sys_mod_count>
        <sys_name>Pet Shop Cart</sys_name>
        <sys_package display_value="Pet Shop Needs Management" source="x_1607167_pet_shop">491ba033c3703210c7e81d12b401315e</sys_package>
        <sys_policy/>
        <sys_scope display_value="Pet Shop Needs Management">491ba033c3703210c7e81d12b401315e</sys_scope>
        <sys_update_name>sp_widget_f19395eec3013e10c7e81d12b40131ce</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-12-02 17:02:32</sys_updated_on>
        <template><![CDATA[<div class="sn-cart-container">

  <!-- CART WITH ITEMS -->
  <div ng-if="c.cartItems.length > 0">

    <!-- HEADER -->
    <div class="cart-header">
      <div class="header-content">
        <h1 class="cart-title">
          <span class="cart-icon">]]>üõí<![CDATA[</span> Shopping Cart
        </h1>
        <div class="item-count-badge">{{c.totalItems}} {{c.totalItems === 1 ? 'item' : 'items'}}</div>
      </div>
      <button class="continue-shopping-btn" ng-click="c.goBack()">‚Üê Continue Shopping</button>
    </div>

    <div class="cart-layout">

      <!-- CART ITEMS LIST -->
      <div class="cart-items-section">
        <div class="cart-item" ng-repeat="item in c.cartItems track by item.sys_id">
          <!-- Item Content -->
          <div class="item-content" ng-click="c.openItem(item.item_sys_id)">
            <div class="item-image-wrapper">
              <img ng-if="item.image" ng-src="/sys_attachment.do?sys_id={{item.image}}" alt="{{item.item}}" class="item-image" />
              <div ng-if="!item.image" class="item-image-placeholder"><span>]]>üêæ<![CDATA[</span></div>
            </div>
            <div class="item-details">
              <h3 class="item-name">{{item.item}}</h3>
              <div class="item-meta">
                <span class="item-brand" ng-if="item.brand"><span class="meta-icon">]]>üè∑<![CDATA[Ô∏è</span>{{item.brand}}</span>
                <span class="item-category" ng-if="item.category"><span class="meta-icon">]]>üì¶<![CDATA[</span>{{item.category}}</span>
              </div>
              <div class="item-pricing">
                <div class="price-row"><span>Unit Price:</span> <span class="unit-price">‚Ç±{{item.price | number:2}}</span></div>
                <div class="quantity-row"><span>Quantity:</span> <span class="quantity-value">√ó{{item.quantity}}</span></div>
              </div>
              <div class="item-total"><span>Subtotal:</span> <span class="total-price">‚Ç±{{item.total_price | number:2}}</span></div>
            </div>
          </div>
          <!-- Remove Button -->
          <button class="remove-item-btn" ng-click="c.removeFromCart(item.sys_id); $event.stopPropagation();" title="Remove item">
           Remove
          </button>
        </div>
      </div>

      <!-- ORDER SUMMARY -->
      <div class="order-summary">
        <div class="summary-card">
          <h2 class="summary-title">Order Summary</h2>
          <div class="summary-details">
            <div class="summary-row"><span>Items ({{c.totalItems}})</span> <span class="summary-value">‚Ç±{{c.grandTotal | number:2}}</span></div>
            <div class="summary-divider"></div>
            <div class="summary-row total-row"><span>Total</span> <span class="total-amount">‚Ç±{{c.grandTotal | number:2}}</span></div>
          </div>
          <button class="checkout-btn" ng-click="c.checkout()" ng-disabled="c.isLoading">
            <span ng-if="!c.isLoading">Proceed to Checkout</span>
            <span ng-if="c.isLoading"><span class="loading-spinner">‚è≥</span> Processing...</span>
          </button>
         
        </div>
      </div>

    </div>
  </div>

  <!-- EMPTY CART -->
  <div class="empty-cart-state" ng-if="c.cartItems.length === 0">
    <div class="empty-illustration">
      <div class="empty-cart-icon">]]>üõí<![CDATA[</div>
      <div class="paw-prints"><span>]]>üêæ<![CDATA[</span><span>]]>üêæ<![CDATA[</span><span>]]>üêæ<![CDATA[</span></div>
    </div>
    <h2>Your Cart is Empty</h2>
    <p>Looks like you haven't added any items yet. Start shopping for your furry friends!</p>
    <button class="shop-now-btn" ng-click="c.goBack()">]]>üê∂<![CDATA[ Start Shopping</button>
  </div>

</div>
]]></template>
    </sp_widget>
    <sys_es_latest_script action="INSERT_OR_UPDATE">
        <id>f19395eec3013e10c7e81d12b40131ce</id>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2025-11-09 10:36:22</sys_created_on>
        <sys_id>952495eec3013e10c7e81d12b40131ba</sys_id>
        <sys_mod_count>0</sys_mod_count>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2025-11-09 10:36:22</sys_updated_on>
        <table>sp_widget</table>
        <use_es_latest>true</use_es_latest>
    </sys_es_latest_script>
</record_update>
